{{ define "lib/hooks/helpers" }}
{{- $pkg := "hooks" -}}
// Code generated by ent, DO NOT EDIT.

package {{ $pkg  }}

type MaybeTx interface {
	Tx() (*ent.Tx, error)
}

func RunOnCompletion(ctx context.Context, m MaybeTx, fn func()) {
	if tx, err := m.Tx(); err == nil {
		tx.OnCommit(
			func(next ent.Committer) ent.Committer {
				return ent.CommitFunc(func(ctx context.Context, tx *ent.Tx) error {
					err := next.Commit(ctx, tx)
					if err != nil {
						slog.ErrorContext(ctx,
							"error commiting tx before running on completion",
							"error", err,
						)
						return err
					}
					fn()
					return nil
				})
			},
		)
	} else {
		fn()
	}
}

{{ end }}